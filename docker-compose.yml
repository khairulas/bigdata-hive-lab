version: '3'

services:
  # --- STORAGE LAYER (HDFS) ---
  namenode:
    image: bde2020/hadoop-namenode:2.0.0-hadoop3.2.1-java8
    container_name: namenode
    restart: always
    ports:
      - "9870:9870"
      - "9000:9000"
    environment:
      - CLUSTER_NAME=test
      - CORE_CONF_fs_defaultFS=hdfs://namenode:9000
    networks:
      - bigdata-net

  datanode:
    image: bde2020/hadoop-datanode:2.0.0-hadoop3.2.1-java8
    container_name: datanode
    restart: always
    environment:
      - SERVICE_PRECONDITION=namenode:9870
      - CORE_CONF_fs_defaultFS=hdfs://namenode:9000
    depends_on:
      - namenode
    networks:
      - bigdata-net

  # --- COMPUTE LAYER (Hive 4.0) ---
  # --- THE SINGLE-NODE HIVE SERVER ---
  hive-server:
    image: apache/hive:4.0.0
    container_name: hive-server
    restart: always
    ports:
      - "10000:10000"
      - "10002:10002"
    environment:
      SERVICE_NAME: hiveserver2
      # CRITICAL FIX: Increase Java Heap Memory to prevent zombie state
      HADOOP_HEAPSIZE: 2048 
      # Disable resource-heavy features for lab environment
      HIVE_SITE_CONF_hive_server2_enable_doAs: "false"
    volumes:
      - ./hive_data:/user/hive/warehouse
    networks:
      - bigdata-net

networks:
  bigdata-net:
    driver: bridge